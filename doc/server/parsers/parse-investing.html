<!DOCTYPE html><html lang="en"><head><title>server/parsers/parse-investing</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="server/parsers/parse-investing"><meta name="groc-project-path" content="src/server/parsers/parse-investing.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/server/parsers/parse-investing.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="getting-parsed-data">GETTING PARSED DATA</h2>
<p>Function request investing.com economic calendar and parse the responce. Parsed events then sends to the sendto_db function</p>
<h3 id="language">LANGUAGE</h3>
<p>To change language you need to chang URL in options variable</p>
<h3 id="filter">FILTER</h3>
<p>Filter on investing.com looks like this:</p>
<pre><code class="lang-javascript">form:{
          dateFrom: <span class="hljs-string">'2015-03-25'</span>,
        dateTo: <span class="hljs-string">'2015-03-25'</span>,
        timeZone: <span class="hljs-number">18</span>,
        quotes_search_text: <span class="hljs-string">''</span>,
        country: [],
        importance: [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
        category: [...]
        timeFilter:  <span class="hljs-string">'timeRemain'</span>,
        timeFrame: <span class="hljs-string">'tomorrow'</span>
      }</code></pre>
<p>If it&#39;ll be needed you can modify code below so that it contained more fields from filter.
In get all values(for fields with arrays) without filtering, just set the field to the empty array []</p>
<h3 id="response">RESPONSE</h3>
<p>Responce event looks like this:</p>
<pre><code class="lang-javascript">{ id: <span class="hljs-string">'55378'</span>,
  time: <span class="hljs-string">'2015-03-27 19:30:00'</span>,
  country: <span class="hljs-string">'Канада'</span>,
  currency: <span class="hljs-string">'CAD'</span>,
  importance: <span class="hljs-string">'bull2'</span>,
  descriptrion: <span class="hljs-string">'Количество чистых спекулятивных позиций по CAD от CFTC'</span>,
  actual: <span class="hljs-string">'-32,7K'</span>,
  forecast: <span class="hljs-string">' '</span>,
  previous: <span class="hljs-string">'-32,8K'</span> 
  }</code></pre></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>),
	cheerio = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cheerio'</span>),
	moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'moment'</span>),
	q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>),
	rek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rekuire'</span>),
	logger = rek(<span class="hljs-string">'winstonlog'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseWithSplitting</span><span class="hljs-params">(lang, fromDate, toDate)</span></span>{
	logger.info(<span class="hljs-string">'enter parseWithSplitting'</span>);
	<span class="hljs-keyword">var</span> prevDate = moment(fromDate),
		endDate = moment(toDate),
		stepTime = {month:<span class="hljs-number">1</span>},
		curDate = moment(fromDate).add(stepTime);
	<span class="hljs-keyword">var</span> promises = [ ];

	<span class="hljs-keyword">while</span> (curDate&lt;endDate){
		promises.push(parseInvesting(lang, prevDate.format(<span class="hljs-string">'YYYY-MM-DD'</span>), curDate.format(<span class="hljs-string">'YYYY-MM-DD'</span>)));
		prevDate.add(stepTime);
		curDate.add(stepTime);
	}
	promises.push(parseInvesting(lang, prevDate.format(<span class="hljs-string">'YYYY-MM-DD'</span>), endDate.format(<span class="hljs-string">'YYYY-MM-DD'</span>)));

	<span class="hljs-keyword">var</span> allPromise = q.defer();
	q.all(promises).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(results)</span></span>{
			<span class="hljs-keyword">var</span> merged = [];
			merged = merged.concat.apply(merged, results);
			allPromise.resolve(merged);
	}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result, error)</span></span>{
		allPromise.reject();	
	})
	<span class="hljs-keyword">return</span> allPromise.promise;
}	

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseInvesting</span><span class="hljs-params">(lang, fromDate, toDate)</span></span>{ 
	<span class="hljs-keyword">var</span> langUrl = {
		<span class="hljs-string">'en'</span>: <span class="hljs-string">'www'</span>,
		<span class="hljs-string">'ru'</span> : <span class="hljs-string">'ru'</span>
	};
	<span class="hljs-keyword">var</span> d = q.defer();

	logger.info(<span class="hljs-string">"entered parseInvesting"</span>);
	<span class="hljs-keyword">var</span> options = {
		url: <span class="hljs-string">'http://'</span>+langUrl[lang]+<span class="hljs-string">'.investing.com/economic-calendar/filter'</span>,
		headers: {
			<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.101 Safari/537.36'</span>,
			<span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span>
		},
		form:{
			dateFrom: fromDate,
			dateTo: toDate,
			quotes_search_text: <span class="hljs-string">''</span>,
			timeZone:<span class="hljs-number">55</span> <span class="hljs-comment">// must be in form to get response without errors. cant be equal to 0. i dont know why. just is.	    </span>
		},
	};

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span><span class="hljs-params">(error, response, body)</span> </span>{
		logger.info(<span class="hljs-string">"entered callback"</span>);
		<span class="hljs-keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="hljs-number">200</span>) {
			<span class="hljs-keyword">var</span> allEvents = [];
			<span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.parse(body);
			<span class="hljs-keyword">if</span> (json[<span class="hljs-string">'renderedFilteredEvents'</span>] != <span class="hljs-literal">null</span>){
				<span class="hljs-keyword">var</span> $ = cheerio.load(json[<span class="hljs-string">'renderedFilteredEvents'</span>]);

				$(<span class="hljs-string">'tr[event_attr_id]'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
					<span class="hljs-keyword">var</span> cols = $(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">'td'</span>)
					<span class="hljs-keyword">var</span> econ_event = {
						eventId: $(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'id'</span>).replace(<span class="hljs-string">'eventRowId_'</span>,<span class="hljs-string">''</span>),
						time: $(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'event_timestamp'</span>),
						country: $(cols[<span class="hljs-string">'1'</span>]).find(<span class="hljs-string">'span'</span>).attr(<span class="hljs-string">'title'</span>),
						currency: $(cols[<span class="hljs-string">'1'</span>]).text().trim(),
						importance: $(cols[<span class="hljs-string">'2'</span>]).attr(<span class="hljs-string">'data-img_key'</span>),
				        description: $(cols[<span class="hljs-string">'3'</span>]).text().trim(),
				        actual: $(cols[<span class="hljs-string">'4'</span>]).text(),
				        forecast: $(cols[<span class="hljs-string">'5'</span>]).text(),
				        previous: $(cols[<span class="hljs-string">'6'</span>]).text()
					}
					allEvents.push(econ_event);			
				})
			}
			d.resolve(allEvents);
		} <span class="hljs-keyword">else</span>{
			 <span class="hljs-comment">//console.log('Error' + response.statusCode);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: raise exception. console.log(response.statusCod)</p></div></div><div class="code"><div class="wrapper">			d.reject();
			logger.error(error);
		}
		
	}
	logger.info(<span class="hljs-string">"about to send request"</span>);
	
	request.post(options, callback);

	<span class="hljs-keyword">return</span> d.promise;
}

<span class="hljs-built_in">module</span>.exports.parseInvesting = parseInvesting;
<span class="hljs-built_in">module</span>.exports.parseWithSplitting = parseWithSplitting;</div></div></div></div></body></html>