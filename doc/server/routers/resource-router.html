<!DOCTYPE html><html lang="en"><head><title>server/routers/resource-router</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="server/routers/resource-router"><meta name="groc-project-path" content="src/server/routers/resource-router.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/server/routers/resource-router.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>),
    bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>),
    rek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rekuire'</span>),
    path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>),
    request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>),
    papa = <span class="hljs-built_in">require</span>(<span class="hljs-string">'babyparse'</span>),
    <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);

<span class="hljs-keyword">var</span> settings = rek(<span class="hljs-string">'settings'</span>),
    TrendetsDb = rek(<span class="hljs-string">'db'</span>),
    logger = rek(<span class="hljs-string">'winstonlog'</span>),
    DbHandler = rek(<span class="hljs-string">'db-handler'</span>);

<span class="hljs-keyword">var</span> router = express.Router();

router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    logger.info(<span class="hljs-string">'GET Router'</span>);
    res.send(<span class="hljs-string">'LOL'</span>);
});
router.use(express.static(path.join(settings.path, <span class="hljs-string">'/web/public'</span>)))

<span class="hljs-comment">//addRestResource('Stocks');</span>
addRestResource(<span class="hljs-string">'Events'</span>);
addRestStocksResource();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p> Adds REST resouce for db model with GET, POST handlers</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRestResource</span>(<span class="hljs-params">name</span>) </span>{

    <span class="hljs-keyword">var</span> settings = {
        resource: name,
        model: name
    };

    <span class="hljs-keyword">var</span> dbHandler = <span class="hljs-keyword">new</span> DbHandler();

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'object'</span>) 
        settings = name; 

    router.route(<span class="hljs-string">'/'</span> + settings.resource)
        .get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
            <span class="hljs-keyword">new</span> TrendetsDb().connect()
                .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
                    <span class="hljs-keyword">return</span> db[settings.model].all()
                })
                .then(responseJson(res), responseError(res));
        })
        .post(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
            <span class="hljs-keyword">return</span> dbHandler.getEventsByFilter(req.body)
                .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">events</span>) </span>{
                    res.json(events);
                });
        });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRestStocksResource</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">var</span> settings = {
            resource: <span class="hljs-string">'Stocks'</span>,
            model: <span class="hljs-string">'Stocks'</span>
    };

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'object'</span>) 
        settings = name;

    router.route(<span class="hljs-string">'/'</span> + settings.resource)
        .post(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
            <span class="hljs-keyword">async</span>.parallel([
                <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
                    <span class="hljs-keyword">var</span> allStocks = [];
                    <span class="hljs-keyword">var</span> options = {
                        url: req.body[<span class="hljs-string">'url'</span>],
                        headers: {
                            <span class="hljs-string">'Host'</span>: <span class="hljs-string">'195.128.78.52'</span>,
                            <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.101 Safari/537.36'</span>,
                            <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span>,
                            <span class="hljs-string">'Accept-Language'</span>: <span class="hljs-string">'ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3'</span>,
                            <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'null'</span>,
                            <span class="hljs-string">'Referer'</span>: <span class="hljs-string">'http://www.finam.ru/profile/forex/eur-usd/export/'</span>,
                            <span class="hljs-string">'Connection'</span>: <span class="hljs-string">'keep-alive'</span>
                        }
                    }
                    logger.info(<span class="hljs-string">"about to send request for stocks"</span>);
                    request.get(options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, response, body</span>) </span>{
                        <span class="hljs-keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="hljs-number">200</span>) {
                            papa.parse(body, {
                                worker: <span class="hljs-literal">true</span>,
                                step: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">results</span>) </span>{
                                    <span class="hljs-keyword">var</span> stock = {
                                        code: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],
                                        period: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>],
                                        date: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>],
                                        time: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>],
                                        open: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">4</span>],
                                        high: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">5</span>],
                                        low: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">6</span>],
                                        close: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">7</span>],
                                        volume: results.data[<span class="hljs-number">0</span>][<span class="hljs-number">8</span>] 
                                    }
                                    allStocks.push(stock);
                                }
                            });
                            callback(<span class="hljs-literal">false</span>, allStocks);
                        } <span class="hljs-keyword">else</span>{
                            logger.error(error);
                            <span class="hljs-built_in">console</span>.log(error);
                            callback(<span class="hljs-literal">true</span>); 
                            <span class="hljs-keyword">return</span>;
                        }  
                    });
                },],
                <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>) </span>{
                    <span class="hljs-keyword">if</span>(err) { <span class="hljs-built_in">console</span>.log(err); res.send(<span class="hljs-number">500</span>,<span class="hljs-string">"Server Error"</span>); <span class="hljs-keyword">return</span>; }
                    res.send(results[<span class="hljs-number">0</span>]);
                }
            );
        });

    
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">responseJson</span>(<span class="hljs-params">resp</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
        resp.json(result);
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">responseError</span>(<span class="hljs-params">resp</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (<span class="hljs-string">''</span> + err).indexOf(<span class="hljs-string">'SQLITE_CONSTRAINT: FOREIGN KEY constraint failed'</span>) !== -<span class="hljs-number">1</span>)
            err = <span class="hljs-string">'Cannot delete entry because it is referenced by other entries.'</span>;
        resp.status(<span class="hljs-number">500</span>).json({ error: <span class="hljs-string">'Serverside error: '</span> + err });
    }
}

<span class="hljs-built_in">module</span>.exports = router;</div></div></div></div></body></html>