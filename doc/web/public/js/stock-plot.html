<!DOCTYPE html><html lang="en"><head><title>web/public/js/stock-plot</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="web/public/js/stock-plot"><meta name="groc-project-path" content="src/web/public/js/stock-plot.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/web/public/js/stock-plot.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init_plot</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> margin = {top: <span class="hljs-number">20</span>, right: <span class="hljs-number">50</span>, bottom: <span class="hljs-number">30</span>, left: <span class="hljs-number">50</span>},
            width = $(<span class="hljs-string">"body"</span>).width() - margin.left - margin.right - <span class="hljs-number">10</span>,
            height = $(<span class="hljs-string">"body"</span>).height() - $(<span class="hljs-string">"#optionsContainer"</span>).height() - margin.top - margin.bottom - <span class="hljs-number">10</span>;

    <span class="hljs-keyword">var</span> parseDate = d3.time.format(<span class="hljs-string">"%d-%b-%y"</span>).parse;

    <span class="hljs-keyword">var</span> x = techan.scale.financetime()
            .range([<span class="hljs-number">0</span>, width]);

    <span class="hljs-keyword">var</span> y = d3.scale.linear()
            .range([height, <span class="hljs-number">0</span>]);

    <span class="hljs-keyword">var</span> candlestick = techan.plot.candlestick()
            .xScale(x)
            .yScale(y);

    <span class="hljs-keyword">var</span> xAxis = d3.svg.axis()
            .scale(x)
            .orient(<span class="hljs-string">"bottom"</span>);

    <span class="hljs-keyword">var</span> yAxis = d3.svg.axis()
            .scale(y)
            .orient(<span class="hljs-string">"left"</span>);

    <span class="hljs-keyword">var</span> ohlcAnnotation = techan.plot.axisannotation()
            .axis(yAxis)
            .format(d3.format(<span class="hljs-string">',.2fs'</span>));

    <span class="hljs-keyword">var</span> timeAnnotation = techan.plot.axisannotation()
            .axis(xAxis)
            .format(d3.time.format(<span class="hljs-string">'%Y-%m-%d'</span>))
            .width(<span class="hljs-number">65</span>)
            .translate([<span class="hljs-number">0</span>, height]);

    <span class="hljs-keyword">var</span> crosshair = techan.plot.crosshair()
            .xScale(x)
            .yScale(y)
            .xAnnotation([timeAnnotation])
            .yAnnotation([ohlcAnnotation])
            .on(<span class="hljs-string">"enter"</span>, enter)
            .on(<span class="hljs-string">"out"</span>, out)
            .on(<span class="hljs-string">"move"</span>, move);

    <span class="hljs-keyword">var</span> svg = d3.select(<span class="hljs-string">"#plotContainer"</span>).append(<span class="hljs-string">"svg"</span>)
            .attr(<span class="hljs-string">"width"</span>, width + margin.left + margin.right)
            .attr(<span class="hljs-string">"height"</span>, height + margin.top + margin.bottom)
            .append(<span class="hljs-string">"g"</span>)
            .attr(<span class="hljs-string">"transform"</span>, <span class="hljs-string">"translate("</span> + margin.left + <span class="hljs-string">","</span> + margin.top + <span class="hljs-string">")"</span>);

    <span class="hljs-keyword">var</span> coordsText = svg.append(<span class="hljs-string">'text'</span>)
            .style(<span class="hljs-string">"text-anchor"</span>, <span class="hljs-string">"end"</span>)
            .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"coords"</span>)
            .attr(<span class="hljs-string">"x"</span>, width - <span class="hljs-number">5</span>)
            .attr(<span class="hljs-string">"y"</span>, <span class="hljs-number">15</span>);

    d3.csv(<span class="hljs-string">"js/data.csv"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, data</span>) </span>{
        <span class="hljs-keyword">var</span> accessor = candlestick.accessor();

        data = data.slice(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>{
            <span class="hljs-keyword">return</span> {
                date: parseDate(d.Date),
                open: +d.Open,
                high: +d.High,
                low: +d.Low,
                close: +d.Close,
                volume: +d.Volume
            };
        }).sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{ <span class="hljs-keyword">return</span> d3.ascending(accessor.d(a), accessor.d(b)); });

        x.domain(data.map(accessor.d));
        y.domain(techan.scale.plot.ohlc(data, accessor).domain());

        svg.append(<span class="hljs-string">"g"</span>)
                .datum(data)
                .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"candlestick"</span>)
                .call(candlestick);

        svg.append(<span class="hljs-string">"g"</span>)
                .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"x axis"</span>)
                .attr(<span class="hljs-string">"transform"</span>, <span class="hljs-string">"translate(0,"</span> + height + <span class="hljs-string">")"</span>)
                .call(xAxis);

        svg.append(<span class="hljs-string">"g"</span>)
                .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"y axis"</span>)
                .call(yAxis);

        svg.append(<span class="hljs-string">'g'</span>)
                .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"crosshair"</span>)
                .call(crosshair);

        svg.append(<span class="hljs-string">'text'</span>)
                .attr(<span class="hljs-string">"x"</span>, <span class="hljs-number">5</span>)
                .attr(<span class="hljs-string">"y"</span>, <span class="hljs-number">15</span>)
                .text(<span class="hljs-string">"Facebook, Inc. (FB)"</span>);
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enter</span>(<span class="hljs-params"></span>) </span>{
        coordsText.style(<span class="hljs-string">"display"</span>, <span class="hljs-string">"inline"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">out</span>(<span class="hljs-params"></span>) </span>{
        coordsText.style(<span class="hljs-string">"display"</span>, <span class="hljs-string">"none"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">move</span>(<span class="hljs-params">coords</span>) </span>{
        coordsText.text(
            timeAnnotation.format()(coords[<span class="hljs-number">0</span>]) + <span class="hljs-string">", "</span> + ohlcAnnotation.format()(coords[<span class="hljs-number">1</span>])
        );
    }
}

$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    init_plot();
})</div></div></div></div></body></html>