<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - src/server/db/db.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>src/server/db/db.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">70.36</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">290</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">42.14</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.86</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var fs = require(&#039;fs&#039;);
var path = require(&#039;path&#039;);
var sqlite3 = require(&#039;sqlite3&#039;).verbose();
var orm = require(&quot;orm&quot;);
var q = require(&#039;q&#039;);
var rek = require(&#039;rekuire&#039;);
var logger = rek(&#039;winstonlog&#039;);

var defaultDbPath = path.join(__dirname, &#039;trendets.db&#039;);

function TrendetsDb(dbPath) {

    dbPath = dbPath || defaultDbPath;

    var self = this,
        connection = null;

    this.connect = function () {
        var d = q.defer();
        connect().then(defineModels)
                 .then(function (db) {
                    Object.keys(db.models).forEach(function (modelName) {
                        self[modelName] = db.models[modelName];
                        promisifyModel(self[modelName]); // TODO: create a promise-shell for db.model || db
                    })
                         
                     d.resolve(self);
                 }, d.reject);
        return d.promise;
    }

    this.exists = function exists() {
        return fs.existsSync(dbPath);
    }

    this.create = function create() {
        if (this.exists())
            throw new Error(&#039;Database at &#039; + dbPath + &#039; already exists.&#039;);

        var res = connect().then(createTables)
                           .then(defineModels)
                           .then(this.disconnect).then(function(){console.log(&#039;creating finished&#039;)});

        console.info(&#039;Database at &#039; + dbPath + &#039; created.&#039;);

        return res;
    }

    this.insert =  function insert(model, obj) {
        // if (obj instanceof Array) {
        //     var d = q.defer();
        //     logger.info(&quot;Inserting in array of length&quot;, obj.length);
        //     for (var i = 0; i &lt; obj.length; i++) {
        //         insert(model, obj[i]);
        //     }
        //     d.resolve();
        //     return d.promise;
        // } else {
        //     var d = q.defer();
        //     model.create([obj], resolveDeferred(d));
        //     logger.info(&quot;Object inserted&quot;);
        //     return d.promise;
        // }
        var d = q.defer();
            
            logger.info(&quot;Inserting in array of length&quot;, obj.length);
            model.create(obj, function (err, items){
                logger.error(err);
                logger.info(items);
                resolveDeferred(d);
        });
        return d.promise;
    }

    this.get = function get(model, filterParam) {
        // var promises = [];
        // Object.keys(filterParam).forEach(function (key) {
        //     console.log(key,&#039;is &#039;,filterParam[key]);
        // });
        
        //description: orm.like(&quot;%&quot;+filterParam[&#039;descriptionText&#039;]+&quot;%&quot;)
        //country: filterParam[&#039;country&#039;]
        //importance: filterParam[&#039;importance&#039;]

        if(filterParam[&#039;importance&#039;].length &lt;= 0 || filterParam[&#039;country&#039;].length &lt;= 0)
        {
            throw new Error(&quot;Provided bad parameters for importance or country&quot;);
        }

        var date = new Date();
        if(filterParam[&#039;dateTo&#039;] !== &#039;&#039;){
            date = new Date(filterParam[&#039;dateTo&#039;]);
            date.setDate(date.getDate() + 1);
        }

        var d = q.defer();
        model.find({time: orm.gte(filterParam[&#039;dateFrom&#039;]) &amp;&amp; orm.lte(date.toISOString())
                , country: filterParam[&#039;country&#039;], importance: filterParam[&#039;importance&#039;]
                , description: orm.like(&quot;%&quot;+filterParam[&#039;descriptionText&#039;]+&quot;%&quot;)}, (function (error, events){
            if (error) {
                console.error(error);
                d.reject(errror);
            } else
            {
                d.resolve(events);
            }   
        }));
        
        return d.promise;
    }

    this.remove = function remove(model, obj) {
        if (obj instanceof Array) {
            var promises = [];
            for (var i = 0; i &lt; obj.length; i++) {
                promises.push(remove(model, obj[i]));
            }
            return q.all(promises);
        } else {
            var d = q.defer();
            obj.remove(function (err){
                if(err) {
                    console.error(err);
                    d.reject(err);
                }
                else {
                    console.log(obj, &quot;removed&quot;);
                    d.resolve();
                }
            });
            return d.promise;
        }
    }

    
    this.delete = function deleteDb() {
        if (this.exists()) {
            fs.unlinkSync(dbPath);
            console.info(&#039;Database at &#039; + dbPath + &#039; deleted.&#039;);
        } else
            console.info(&#039;Database at &#039; + dbPath + &#039; not found - nothing to delete.&#039;);
    }


    this.disconnect = function disconnect(db) {
        console.log(&#039;Disconnecting&#039;)
        var d = q.defer();
        db.close(resolveDeferred(d));
        return d.promise.then(function () {
            connection = null;
        });
    }

    function connect() {
        var d = q.defer();
        if (connection !== null) {
            d.resolve(connection);
            return d.promise;
        }
        orm.connect(&#039;sqlite://&#039; + dbPath, resolveDeferred(d));
        return d.promise.then(function (db) {
            connection = db;
            return db;
        });
    }


    function createTables(db) {
        console.log(&#039;creating Tables&#039;);
        return runSqlFile(db, path.join(__dirname, &#039;tables.sql&#039;));
    }

    function runSqlFile(db, filePath) {
        console.log(filePath);
        var sql = fs.readFileSync(filePath, { encoding: &#039;utf8&#039; }),
            d = q.defer();
        db.driver.db.exec(sql, resolveDeferred(d, db));
        return d.promise;
    }


    function defineModels(db) {

        var d = q.defer();

        console.log(&#039;ORM models start initializing.&#039;);
        var Events = db.define(&#039;Events&#039;, getColumnMapping({
            eventId: { type: &#039;number&#039;, mapsTo: &#039;EventId&#039; },
            time: { type: &#039;date&#039;, mapsTo: &#039;DateTime&#039; },
            country : { type: &#039;text&#039;, mapsTo: &#039;Country&#039; },
            currency : { type: &#039;text&#039;, mapsTo: &#039;Currency&#039; },
            importance : { type: &#039;text&#039;, mapsTo: &#039;Importance&#039; },
            description : { type: &#039;text&#039;, mapsTo: &#039;Description&#039; },
            actual: { type: &#039;text&#039;, mapsTo: &#039;Actual&#039; },
            forecast: { type: &#039;text&#039;, mapsTo: &#039;Forecast&#039; },
            previous: { type: &#039;text&#039;, mapsTo: &#039;Previous&#039; },
        }));
        

        console.log(&#039;ORM models initialized.&#039;);
        d.resolve(db);

        return d.promise;
    }

    function getColumnMapping(additionalColumnMapping) {
        var commonMap = {
            id: { type: &#039;serial&#039;, key: true, mapsTo: &#039;Id&#039; }
        };
        for (var f in additionalColumnMapping) {
            commonMap[f] = additionalColumnMapping[f];
            if (!commonMap[f].mapsTo)
                commonMap[f].mapsTo = f.substring(0, 1).toUpperCase() + f.substring(1, f.length);
        }
        return commonMap;
    }


    function one(model/*, arg1, arg2, ..., argN */) {
        var args = Array.prototype.slice.call(arguments, 1);
        return deferFunc(model, &#039;one&#039;, args);
    }

    function find(model/*, arg1, arg2, ..., argN */) {
        var args = Array.prototype.slice.call(arguments, 1);
        return deferFunc(model, &#039;find&#039;, args);
    }

    function all(model/*, arg1, arg2, ..., argN */) {
        var args = Array.prototype.slice.call(arguments, 1);
        return deferFunc(model, &#039;all&#039;, args);
    }

    function get(model/*, arg1, arg2, ..., argN */) {
        var args = Array.prototype.slice.call(arguments, 1);
        return deferFunc(model, &#039;get&#039;, args);
    }

    function count(model/*, arg1, arg2, ..., argN */) {
        var args = Array.prototype.slice.call(arguments, 1);
        return deferFunc(model, &#039;count&#039;, args);
    }

    function exists(model/*, arg1, arg2, ..., argN */) {
        var args = Array.prototype.slice.call(arguments, 1);
        return deferFunc(model, &#039;exists&#039;, args);
    }

    //  wraps obj[funcName] function into promise and calls.
    function deferFunc(obj, funcName, argsArray) {
        var d = q.defer();
        argsArray.push(resolveDeferred(d));
        obj[funcName].apply(obj, argsArray);
        return d.promise;
    }

    function promisifyModel(model) {
        promisifyFunc(model, &#039;one&#039;);
        //promisifyFunc(model, &#039;get&#039;);
        //promisifyFunc(model, &#039;all&#039;);
        //promisifyFunc(model, &#039;create&#039;);
    }

    function promisifyFunc(obj, funcName) {
        var original = {},
            originalFunc = obj[funcName];
        original[funcName] = obj[funcName];
        obj[funcName] = function () {
            var args = Array.prototype.slice.call(arguments),
                d = q.defer();
            args.push(resolveDeferred(d));
            originalFunc.apply(obj, args);
            return d.promise;
            //return deferFunc(original, funcName, args);
        }
    }
}

function resolveDeferred(deferred, resolveValue) {
    return function (err, res) {
        if (err) {
            console.error(err);
            deferred.reject(err);
        } else
            deferred.resolve(resolveValue || res);
    }
}


module.exports = TrendetsDb;</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
